# Beer Mile Registration Bot

Телеграм-бот для регистрации участников и волонтеров на гонку.

## Быстрый старт

### Запуск через Docker
1. Установите [Docker](https://docs.docker.com/get-docker/) и [Docker Compose](https://docs.docker.com/compose/install/).
2. Создайте файл `.env` в корне проекта с переменными окружения:
   ```env
   BOT_TOKEN=ваш_токен
   ADMIN_ID=123456789
   ```
3. Создайте директории `data`, `logs` и `images` в корне проекта:
   ```bash
   mkdir data logs images
   ```
4. Поместите изображение спонсоров (`sponsor_image.jpg`) в директорию `images`.
5. Запустите бота:
   ```bash
   docker-compose up -d
   ```

### Запуск без Docker
1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Задайте переменные окружения:
   ```bash
   export BOT_TOKEN=ваш_токен
   export ADMIN_ID=123456789
   ```
3. Создайте директории `data`, `logs` и `images` в корне проекта:
   ```bash
   mkdir data logs images
   ```
4. Поместите изображение спонсоров (`sponsor_image.jpg`) в директорию `images`.
5. Запустите бота:
   ```bash
   python main.py
   ```

## Отладка
- Логи приложения сохраняются в `logs/bot.log` и в Docker-логах.
- Для просмотра логов Docker выполните:
  ```bash
  docker logs beermile_reg-bot-1
  ```
- Проверьте наличие файлов `config.json`, `messages.json`, директорий `data`, `logs` и `images` перед запуском.
- Убедитесь, что файл `sponsor_image.jpg` находится в `/app/images/` (в контейнере) или `./images/` (при локальном запуске).
- Убедитесь, что переменные `BOT_TOKEN` и `ADMIN_ID` заданы корректно.
- Для проверки работы обработчиков:
  - Отправьте команду `/start` в Telegram-бот.
  - Для администратора (`ADMIN_ID`) бот вернет список команд: `/participants`, `/stats`, `/paid`, `/remove`, `/export`.
  - Проверьте в `logs/bot.log`, зарегистрированы ли обработчики (сообщение "Обработчики успешно зарегистрированы").
  - Если команды не работают, убедитесь, что `BOT_TOKEN` действителен, и проверьте сетевые настройки контейнера.
- Для экспорта данных в CSV (команда `/export`):
  - Убедитесь, что используется `BufferedInputFile` для отправки файлов в `aiogram` 3.x.
  - CSV-файл формируется с кодировкой UTF-8 с BOM для корректного отображения кириллицы в приложениях, таких как Excel.
  - Данные разделяются с использованием разделителя, указанного в `config.json` (по умолчанию `;` для совместимости с русскоязычными системами).
  - Проверьте логи на наличие сообщения "CSV-файл успешно отправлен".
  - Для открытия CSV в Excel:
    - Используйте **Данные -> Из текста/CSV**, выберите кодировку **UTF-8** и разделитель (например, `;`).
    - Или откройте файл в текстовом редакторе, проверьте разделитель и сохраните с кодировкой UTF-8 с BOM.

## Переменные окружения
- `BOT_TOKEN` — токен вашего Telegram-бота.
- `ADMIN_ID` — Telegram ID администратора (целое число).

## Конфигурация
- **messages.json**: Содержит все текстовые сообщения бота. Редактируйте для изменения текстов.
- **config.json**: Настройки лимитов участников (`max_runners`, `max_volunteers`) и разделителя CSV (`csv_delimiter`).
- **sponsor_image.jpg**: Изображение спонсоров, отправляемое после регистрации. Поместите файл в `./images/` (локально) или `/app/images/` (в контейнере).

## Структура проекта
- `main.py`: Точка входа для запуска бота.
- `handlers.py`: Обработчики команд и сообщений.
- `database.py`: Функции для работы с SQLite базой данных.
- `messages.json`: Тексты сообщений.
- `config.json`: Настройки лимитов и разделителя CSV.
- `data/race_participants.db`: SQLite база данных.
- `logs/bot.log`: Лог-файл приложения.
- `images/sponsor_image.jpg`: Изображение спонсоров.

## Требования
- Python 3.8+
- aiogram 3.4.1
- python-dotenv
- Docker (для запуска через контейнер)